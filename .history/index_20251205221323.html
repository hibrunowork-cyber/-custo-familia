<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnÃ¡lise de Gastos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="processar_txt.js"></script>
</head>
<body>
    <div class="container">

        <div class="chart-section">
            <div class="chart-wrapper">
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
                <div class="chart-legend" id="chartLegend"></div>
            </div>
        </div>

        <!-- INCOMES (Receitas) âœ¨ PRIMEIRA SEÃ‡ÃƒO -->
        <div class="list-section list-section-income">
            <div class="filters-row income-title-row">
                <h2 class="income-title">Income</h2>
                <button id="btnResetarFiltrosIncome" class="btn-cta">Resetar Filtros</button>
            </div>
            
            <div class="filters-row">   
                <div class="filter-group">
                    <label for="filterMesIncome">MÃªs:</label>
                    <select id="filterMesIncome">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterFonteIncome">Fonte:</label>
                    <select id="filterFonteIncome">
                        <option value="">Todas</option>
                        <option value="Meli">Meli</option>
                        <option value="Neuro">Neuro</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterRecorrenciaIncome">RecorrÃªncia:</label>
                    <select id="filterRecorrenciaIncome">
                        <option value="">Todas</option>
                        <option value="anual">Anual</option>
                        <option value="mensal">Mensal</option>
                        <option value="pontual">Pontual</option>
                    </select>
                </div>
            </div>
            
            <div class="categories-header">
                <div class="fonte-total-box">
                    <div class="fonte-total-value" id="fonteTotalIncome">R$ 0,00</div>
                </div>
                <div class="comparacao-mes" id="comparacaoMesIncome">
                    <div class="comparacao-valor" id="comparacaoValorIncome">- R$ 0,00</div>
                    <div class="comparacao-label" id="comparacaoLabelIncome">Sem dados</div>
                    <div class="comparacao-indicador" id="comparacaoIndicadorIncome"></div>
                </div>
            </div>

            <div id="categoriesListIncome"></div>
        </div>

        <!-- OUTCOMES (Despesas) ðŸ’¸ SEGUNDA SEÃ‡ÃƒO -->
        <div class="list-section">
            <div class="filters-row outcome-title-row">
                <h2 class="outcome-title">Outcome</h2>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="toggleConsolidado" style="margin: 0; font-family: 'Inter', sans-serif; font-size: 14px; color: #333;">Income consolidado:</label>
                <label class="form-switch">
                    <input type="checkbox" id="toggleConsolidado" checked>
                    <i></i>
                </label>
                </div>
            </div>
            
            <div class="filters-row">
                <div class="filter-group">
                    <label for="filterCarteira">Carteira:</label>
                    <select id="filterCarteira">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterMes">MÃªs:</label>
                    <select id="filterMes">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterFonte">Fonte:</label>
                    <select id="filterFonte">
                        <option value="">Todas</option>
                    </select>
                </div>
            </div>
            
            <div class="filters-row">
                <div class="filter-group">
                    <label for="filterRecorrencia">RecorrÃªncia:</label>
                    <select id="filterRecorrencia">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterParcelado">Parcelado:</label>
                    <select id="filterParcelado">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterCategoria">Categoria:</label>
                    <select id="filterCategoria">
                        <option value="">Todas</option>
                    </select>
                </div>
            </div>
            
            <div class="ctas-row">
                <button id="btnResetarFiltros" class="btn-cta">Resetar</button>
                <button id="btnDownloadPDF" class="btn-cta">Download</button>
            </div>
            
            <div class="categories-header">
                <div class="fonte-total-box">
                    <div class="fonte-total-value" id="fonteTotal">R$ 0,00</div>
                </div>
                <div class="comparacao-mes" id="comparacaoMes">
                    <div class="comparacao-valor" id="comparacaoValor">- R$ 0,00</div>
                    <div class="comparacao-label" id="comparacaoLabel">Sem dados</div>
                    <div class="comparacao-indicador" id="comparacaoIndicador"></div>
                </div>
            </div>

            <div id="categoriesList"></div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Aguardar DOM e app.js carregarem antes de carregar dados
        function carregarDados() {
            // Verificar se as funÃ§Ãµes estÃ£o disponÃ­veis
            if (typeof inicializarDashboard === 'undefined') {
                console.error("Erro: inicializarDashboard nÃ£o estÃ¡ definido. Verifique se app.js foi carregado.");
                setTimeout(carregarDados, 100); // Tentar novamente apÃ³s 100ms
                return;
            }

            // Carregar dados diretamente dos arquivos TXT
            console.log("ðŸ”„ Iniciando carregamento de dados TXT...");
            carregarDadosTxt().then(({ dadosOutcome, dadosIncome }) => {
                console.log("âœ… Dados recebidos:", { 
                    outcome: dadosOutcome?.length || 0, 
                    income: dadosIncome?.length || 0 
                });
                
                if (!dadosOutcome || dadosOutcome.length === 0) {
                    console.warn("âš ï¸ Aviso: OUTCOME.txt estÃ¡ vazio ou invÃ¡lido");
                }
                if (!dadosIncome || dadosIncome.length === 0) {
                    console.warn("âš ï¸ Aviso: INCOME.txt estÃ¡ vazio ou invÃ¡lido");
                }
                
                window.dados = dadosOutcome || [];
                window.dadosIncome = dadosIncome || [];
                
                console.log("ðŸ”„ Inicializando dashboard com", window.dados.length, "registros");
                if (typeof inicializarDashboard === 'function') {
                    inicializarDashboard(window.dados);
                    console.log("âœ… Dashboard inicializado");
                } else {
                    console.error("âŒ Erro: inicializarDashboard nÃ£o Ã© uma funÃ§Ã£o");
                }
                
                if (typeof inicializarIncome === 'function') {
                    console.log("ðŸ”„ Inicializando income com", window.dadosIncome.length, "registros");
                    inicializarIncome(window.dadosIncome);
                    console.log("âœ… Income inicializado");
                } else {
                    console.warn("âš ï¸ inicializarIncome nÃ£o estÃ¡ disponÃ­vel");
                }
            }).catch(err => {
                console.error("Erro ao carregar dados TXT:", err);
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'padding: 20px; text-align: center; font-family: Arial, sans-serif;';
                errorDiv.innerHTML = `
                    <h1 style="color: #d32f2f;">Erro ao carregar dados</h1>
                    <p><strong>Erro:</strong> ${err.message}</p>
                    <p>Verifique:</p>
                    <ul style="text-align: left; display: inline-block;">
                        <li>Se os arquivos src/OUTCOME.txt e src/INCOME.txt existem</li>
                        <li>Se o servidor HTTP estÃ¡ rodando corretamente</li>
                        <li>Se os arquivos estÃ£o na pasta src/</li>
                    </ul>
                    <p style="margin-top: 20px;"><small>Abra o console do navegador (F12) para mais detalhes.</small></p>
                `;
                document.body.innerHTML = '';
                document.body.appendChild(errorDiv);
            });
        }

        // Iniciar carregamento quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', carregarDados);
        } else {
            carregarDados();
        }
    </script>
</body>
</html>
